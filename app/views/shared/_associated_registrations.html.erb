<script>
  $( document ).ready(function(){
    //load all registrations from localstorage, which are in the associated records list into a hash of registrations
    let all_local_registrations = {};
    $( "td[data-hashed_email]" ).each( function( index, td ) {
      let hashed_email = td.getAttribute('data-hashed_email');
      let encrypted_data = localStorage.getItem(hashed_email);
      all_local_registrations[hashed_email] = JSON.parse(encrypted_data);
      });
    console.log("load from localStorage");
    //server-request: send hash and decrypt registrations inside
    $.ajax({
      url: '/decrypt',
      type: 'POST',
      headers: {
      'X-CSRF-Token': '<%= form_authenticity_token.to_s %>'
      },
      data: {"encrypted_registrations": all_local_registrations},
      dataType:'json',
      success: function (data, textStatus, jqXHR) {
        console.log("completed");
        $.each(data, function(index,registration) {
          console.log(registration)
          if (registration.length > 0){//if this record wasn't cleared from local storage'
            console.log("table", registration[1].name, "memory_loss", registration[1].memory_loss);
          //fill in tds in the list
            element = document.querySelectorAll("[data-hashed_email='"+registration[0]+"']");
            element[0].innerHTML = registration[1]["name"];   
            }
          else {
            console.log("memory loss for this record")}
        });
      }
    });
  });
</script>

<h4>You registered <%= pluralize(associated_registrations.length, "person") %>:</h4>
<div class="table-wrapper">
<table class="text-center table-hover">
  <tr>
    <th><div title="If the registration-data was deleted from your browser, you can you can look it up in your emails with this ID">ID</div></th>
    <th><div title="Name is not showing if the data in your browser was deleted">Name</div></th>
    <th><div title="Did the registered person confirm the link in the email they got?">Confirmed</div></th>
    <th><div title="Check the data and optionally edit">Edit</div></th>
    <th><div title="Use delete if you typed the wrong email-address">Delete</div></th>
  </tr>
<% associated_registrations.each do |r| %>
  <tr>
    <td><%= r.id %></td>
    <td data-hashed_email=<%=r.hashed_email%> ></td>
    <td><%= better_read(r.confirmed) %></td>
    <td><%= link_to registration_path(r) do %><i class="glyphicon glyphicon-edit"></i><% end %></td>
    <td><%= link_to(registration_path(r), method: :delete, data:{confirm: "Are you sure that you want to delete this registration?"}) do %><i class="glyphicon glyphicon-trash"></i><% end %></td>
  </tr>
<% end %>
</table>
</div>